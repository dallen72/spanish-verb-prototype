# ================================================================================================================
# DEVELOPMENT BUILD - MAIN BRANCH
# ================================================================================================================
# 
# PURPOSE: Creates development builds for testing and team access
# TRIGGER: Runs on every push to the main branch (after PR merge)
# BUILD MODE: Debug builds (faster compilation, includes debug symbols)
# OUTPUT: Builds uploaded to GitHub artifacts AND Itch.io dev channels
# 
# This workflow:
# - Builds the game for all platforms (Windows, Linux, macOS, Web)
# - Uploads build artifacts to GitHub for team download (7-day retention)
# - Uploads Windows and Web builds to Itch.io dev channels for testing
# - Provides immediate feedback on main branch stability
# 
# Itch.io Channels:
# - windows-dev: Latest Windows debug build
# - web-dev: Latest Web debug build
# 
# Use these builds for:
# - Internal testing and QA
# - Demo purposes
# - Early access for team members
# ================================================================================================================

name: Build And Push - Development
on:
  push:
    branches: [main]
# Add environment variables
env:
  GODOT_VERSION: 4.5

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
          clean: true  # Force clean checkout
      
      - name: Build Full Game (Debug)
        uses: ./.github/actions/build-game
        with:
          build-mode: debug
      
      - name: Verify Build Output
        uses: ./.github/actions/verify-build
        with:
          build-mode: debug

      # Upload to Itch.io dev channels
      - name: Upload Windows Build to Itch.io
        uses: ./.github/actions/upload-to-itch
        with:
          file-path: builds/windows-debug/
          channel: windows-dev
          game-id: cgdc-community-game/shepherds-watch
          api-key: ${{ secrets.BUTLER_API_KEY }}

      - name: Upload Web Build to Itch.io
        uses: ./.github/actions/upload-to-itch
        with:
          file-path: builds/web-debug/
          channel: web-dev
          game-id: cgdc-community-game/shepherds-watch
          api-key: ${{ secrets.BUTLER_API_KEY }}

  notify-discord-dev:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Notify Discord - Itch.io Development Build
        uses: ./.github/actions/notify-discord-itch
        with:
          build-type: development
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}