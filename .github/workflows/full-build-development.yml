name: Upload to Itch.io
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  upload:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.5
    steps:
    - uses: actions/checkout@v5

    - name: Verify Butler is installed
      run: butler -V
    
    - name: List build files for debugging
      run: |
        echo "Files in build directory:"
        ls -la build/ || echo "Build directory not found or empty"
    
    - name: Extract game name from ITCHURL for filename
      id: extract-game-name
      env:
        ITCHURL: ${{ vars.ITCHURL }}
      run: |
        # Extract game-name from URL like https://username.itch.io/game-name
        GAME_NAME=$(echo "$ITCHURL" | sed -E 's|https://[^/]+\.itch\.io/([^/]+).*|\1|')
        echo "game-name=$GAME_NAME" >> $GITHUB_OUTPUT
        echo "Extracted game name for filename: $GAME_NAME"
    
    - name: Upload Web Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        WEBBUILD: ${{ vars.WEBBUILD || 'true' }}
      run: |
        if [ "$WEBBUILD" != "true" ]; then
          echo "Skipping Web build upload (WEBBUILD=$WEBBUILD)"
          exit 0
        fi
        FILE_NAME="${{ steps.extract-game-name.outputs.game-name }}Web.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:web
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload Linux Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        LINUXBUILD: ${{ vars.LINUXBUILD || 'false' }}
      run: |
        if [ "$LINUXBUILD" != "true" ]; then
          echo "Skipping Linux build upload (LINUXBUILD=$LINUXBUILD)"
          exit 0
        fi
        FILE_NAME="${{ steps.extract-game-name.outputs.game-name }}Linux.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:linux
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload macOS Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        MACOSBUILD: ${{ vars.MACOSBUILD || 'false' }}
      run: |
        if [ "$MACOSBUILD" != "true" ]; then
          echo "Skipping macOS build upload (MACOSBUILD=$MACOSBUILD)"
          exit 0
        fi
        FILE_NAME="${{ steps.extract-game-name.outputs.game-name }}MacOS.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:osx
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload Windows Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        WINDOWSBUILD: ${{ vars.WINDOWSBUILD || 'true' }}
      run: |
        if [ "$WINDOWSBUILD" != "true" ]; then
          echo "Skipping Windows build upload (WINDOWSBUILD=$WINDOWSBUILD)"
          exit 0
        fi
        FILE_NAME="${{ steps.extract-game-name.outputs.game-name }}Windows.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:windows
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi

