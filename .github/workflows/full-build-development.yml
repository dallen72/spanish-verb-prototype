name: Upload to Itch.io
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  upload:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    environment: playwright
    container:
      image: barichello/godot-ci:4.5
    steps:
    - uses: actions/checkout@v5

    - name: Verify Butler is installed
      run: butler -V
    
    - name: List build files for debugging
      run: |
        echo "Files in build directory:"
        ls -la build/ || echo "Build directory not found or empty"
    
    - name: Upload Web Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        WEBBUILD: ${{ vars.WEBBUILD || 'true' }}
      run: |
        if [ "$WEBBUILD" != "true" ]; then
          echo "Skipping Web build upload (WEBBUILD=$WEBBUILD)"
          exit 0
        fi
        FILE_NAME="${PROJECTNAME}Web.zip"
        echo "PROJECTNAME is: $PROJECTNAME"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:web
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload Web Build Artifact to GitHub
      if: ${{ vars.WEBBUILD == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/${{ vars.PROJECTNAME }}Web.zip
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload Linux Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        LINUXBUILD: ${{ vars.LINUXBUILD || 'false' }}
      run: |
        if [ "$LINUXBUILD" != "true" ]; then
          echo "Skipping Linux build upload (LINUXBUILD=$LINUXBUILD)"
          exit 0
        fi
        FILE_NAME="${PROJECTNAME}Linux.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:linux
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload Linux Build Artifact to GitHub
      if: ${{ vars.LINUXBUILD == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: build/${{ vars.PROJECTNAME }}Linux.zip
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload macOS Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        MACOSBUILD: ${{ vars.MACOSBUILD || 'false' }}
      run: |
        if [ "$MACOSBUILD" != "true" ]; then
          echo "Skipping macOS build upload (MACOSBUILD=$MACOSBUILD)"
          exit 0
        fi
        FILE_NAME="${PROJECTNAME}MacOS.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:osx
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload macOS Build Artifact to GitHub
      if: ${{ vars.MACOSBUILD == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: build/${{ vars.PROJECTNAME }}MacOS.zip
        retention-days: 7
        if-no-files-found: ignore
    
    - name: Upload Windows Build
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
        PROJECTNAME: ${{ vars.PROJECTNAME }}
        WINDOWSBUILD: ${{ vars.WINDOWSBUILD || 'true' }}
      run: |
        if [ "$WINDOWSBUILD" != "true" ]; then
          echo "Skipping Windows build upload (WINDOWSBUILD=$WINDOWSBUILD)"
          exit 0
        fi
        FILE_NAME="${PROJECTNAME}Windows.zip"
        echo "Looking for file: build/$FILE_NAME"
        if [ -f "build/$FILE_NAME" ]; then
          butler push "build/$FILE_NAME" island-treehouse/${PROJECTNAME}:windows
        else
          echo "Warning: $FILE_NAME not found in build directory"
          echo "Available files:"
          ls -la build/*.zip 2>/dev/null || echo "No zip files found"
          exit 1
        fi
    
    - name: Upload Windows Build Artifact to GitHub
      if: ${{ vars.WINDOWSBUILD == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: build/${{ vars.PROJECTNAME }}Windows.zip
        retention-days: 7
        if-no-files-found: ignore

